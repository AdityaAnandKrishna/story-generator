#!/usr/bin/env python

import argparse
import csv
import simplejson

class DataTransformer(object):
    def transform(self, input_file, output_file):
        year_header = []
        output_dict = {}
        states_index_map = {}
        with open(input_file, "rb") as in_csv_file:
            csv_reader = csv.reader(in_csv_file, delimiter=",")
            for row in csv_reader:
                if int(csv_reader.line_num) == 1:
                    for col_index in range(len(row)):
                        if row[col_index].strip():
                            states_index_map[col_index] = row[col_index].strip()
                elif int(csv_reader.line_num) == 2:
                    year_header = row
                else:
                    indicator = row[0].strip()
                    output_dict[indicator] = {}
                    state = ""
                    for col_index in range(1,len(row)):
                        if col_index in states_index_map:
                            state = states_index_map[col_index]
                            output_dict[indicator][state] = {}
                            output_dict[indicator][state][year_header[col_index].strip()] = row[col_index].strip()
                            output_json = simplejson.dumps(output_dict)
                            output_file_obj = open(output_file, "w")
                            output_file_obj.write(output_json)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Transforms input CSV file into JSON file")
    parser.add_argument("input_file", help="Input CSV filepath")
    parser.add_argument("output_file", help="Output JSON filepath")
    args = parser.parse_args()
    obj = DataTransformer()
    if not args.input_file or not args.output_file:
        print("Please pass input and output filepaths")
    else:
        obj.transform(args.input_file, args.output_file)
